<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AR Food Chain â€“ Grass â†’ Grasshopper â†’ Frog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

  <!-- AR.js with NFT support -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin:0; overflow:hidden; }
    .hud {
      position: fixed; bottom: 14px; left: 50%; transform: translateX(-50%);
      display: grid; grid-template-columns: repeat(5, auto); gap: 8px;
      font: 600 14px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      z-index: 10; pointer-events: none;
    }
    .hud.hidden { display: none; }
    .hud button {
      pointer-events: auto;
      padding: 10px 12px; border: 0; border-radius: 10px;
      background: rgba(255,255,255,.9);
    }
  </style>

  <script>
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

    // ----------- TAP / DOUBLE TAP / LONG PRESS -----------
    AFRAME.registerComponent('tap-gestures', {
      schema: {longMs:{default:500}},
      init () {
        let lastTap = 0, pressTimer = null, down = false;
        this.el.addEventListener('mousedown', () => {
          down = true;
          const now = performance.now();
          if (now - lastTap < 300) this.el.emit('doubletap');
          lastTap = now;
          pressTimer = setTimeout(() => { if (down) this.el.emit('longpress'); }, this.data.longMs);
        });
        this.el.addEventListener('mouseup', () => {
          down = false;
          clearTimeout(pressTimer);
          this.el.emit('tap');
        });
        this.el.addEventListener('touchstart', e => e.preventDefault(), {passive:false});
      }
    });

    // ----------- DRAG ON PLANE -----------
    AFRAME.registerComponent('drag-on-plane', {
      schema: { plane: {type: 'selector'}, yOffset: {default: 0.25}, radius: {default: 1.2} },
      init () {
        this.dragging = false;
        this.scene = this.el.sceneEl;
        this.rayEl = document.querySelector('#ray');
        this.el.addEventListener('mousedown', () => this.dragging = true);
        window.addEventListener('mouseup',   () => this.dragging = false);
        window.addEventListener('touchend',  () => this.dragging = false);
        this.scene.addEventListener('mousemove', () => this.updateDrag());
        this.scene.addEventListener('touchmove', () => this.updateDrag());
      },
      updateDrag () {
        if (!this.dragging) return;
        const raycaster = this.rayEl.getObject3D('raycaster');
        const planeMesh = this.data.plane.getObject3D('mesh');
        if (!raycaster || !planeMesh) return;

        planeMesh.updateMatrixWorld();
        const normal = new THREE.Vector3(0,1,0)
            .applyQuaternion(planeMesh.getWorldQuaternion(new THREE.Quaternion()));
        const point  = planeMesh.getWorldPosition(new THREE.Vector3());
        const plane  = new THREE.Plane().setFromNormalAndCoplanarPoint(normal, point);

        const ray = raycaster.ray;
        const hit = new THREE.Vector3();
        if (ray.intersectPlane(plane, hit)) {
          const local = this.el.parentEl.object3D.worldToLocal(hit.clone());
          const r = Math.hypot(local.x, local.z);
          const maxR = this.data.radius;
          if (r > maxR){
            const k = maxR / r;
            local.x *= k; local.z *= k;
          }
          this.el.setAttribute('position', `${local.x} ${this.data.yOffset} ${local.z}`);
        }
      }
    });

    // ----------- PINCH TO SCALE -----------
    AFRAME.registerComponent('pinch-scale', {
      schema: {min:{default:0.2}, max:{default:3}},
      init(){
        this.active = false; this.startD = 0; this.startScale = null;
        const dist = (a,b)=> Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY);

        const onStart = (e) => {
          if (e.touches?.length === 2){
            this.active = true;
            this.startD = dist(e.touches[0], e.touches[1]);
            this.startScale = {...this.el.getAttribute('scale')};
          }
        };
        const onMove = (e) => {
          if (!this.active || e.touches?.length < 2) return;
          const d = dist(e.touches[0], e.touches[1]);
          const mult = d / this.startD;
          const ns = {
            x: clamp(this.startScale.x * mult, this.data.min, this.data.max),
            y: clamp(this.startScale.y * mult, this.data.min, this.data.max),
            z: clamp(this.startScale.z * mult, this.data.min, this.data.max),
          };
          this.el.setAttribute('scale', ns);
        };
        const onEnd = () => this.active = false;

        window.addEventListener('touchstart', onStart, {passive:false});
        window.addEventListener('touchmove',  onMove,  {passive:false});
        window.addEventListener('touchend',   onEnd);
        window.addEventListener('touchcancel',onEnd);
      }
    });

    // ----------- TWIST ROTATE -----------
    AFRAME.registerComponent('twist-rotate', {
      schema:{degPerRad:{default:57.2958}},
      init(){
        this.active = false; this.startA = 0; this.startRotY = 0;
        const angle = (a,b)=> Math.atan2(b.clientY-a.clientY, b.clientX-a.clientX);

        const onStart = (e)=>{
          if (e.touches?.length === 2){
            this.active = true;
            this.startA = angle(e.touches[0], e.touches[1]);
            this.startRotY = this.el.getAttribute('rotation').y;
          }
        };

        const onMove = (e)=>{
          if (!this.active || e.touches?.length < 2) return;
          const a = angle(e.touches[0], e.touches[1]);
          const delta = (a - this.startA) * this.data.degPerRad;
          const r = this.el.getAttribute('rotation');
          this.el.setAttribute('rotation', {x:r.x, y:this.startRotY + delta, z:r.z});
        };

        const onEnd = ()=> this.active = false;

        window.addEventListener('touchstart', onStart, {passive:false});
        window.addEventListener('touchmove',  onMove,  {passive:false});
        window.addEventListener('touchend',   onEnd);
        window.addEventListener('touchcancel',onEnd);
      }
    });

    // ----------- SPIN + RANDOM COLOR -----------
    AFRAME.registerComponent('spin-toggle', {
      schema:{speed:{default:4000}},
      init(){
        this.spinning = false;
        this.el.addEventListener('toggle-spin', ()=> {
          this.spinning = !this.spinning;
          if (this.spinning) {
            this.el.setAttribute('animation__spin',
                    `property: rotation; to: 0 360 0; loop: true; dur: ${this.data.speed}`);
          } else {
            this.el.removeAttribute('animation__spin');
          }
        });
        this.el.addEventListener('random-color', ()=> {
          const colors = ['#4CC3D9','#7BC8A4','#FFC65D','#EF2D5E','#FFFFFF'];
          const c = colors[Math.floor(Math.random()*colors.length)];
          this.el.setAttribute('material','color',c);
        });
      }
    });
  </script>
</head>

<body>

<!-- ðŸŽ‰ Message banner -->
<div id="message" style="
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  padding: 12px 20px;
  background: rgba(0,0,0,0.75);
  color: white;
  font-size: 20px;
  font-weight: 700;
  border-radius: 10px;
  display: none;
  z-index: 20;
">
  ðŸŽ‰ Congratulations! You guessed it right!
</div>

<!-- HUD -->
<div class="hud" id="hud">
  <button id="btn-rot-l">âŸ²</button>
  <button id="btn-rot-r">âŸ³</button>
  <button id="btn-scale--">âˆ’</button>
  <button id="btn-scale-+">ï¼‹</button>
  <button id="btn-color">ðŸŽ¨</button>
</div>

<a-scene
  embedded
  renderer="colorManagement: true; physicallyCorrectLights: true"
  xr-mode-ui="enabled: false"
  arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false;">

  <a-entity id="ray" cursor="rayOrigin: mouse" raycaster="objects: .raytarget"></a-entity>

  <a-entity light="type: ambient; intensity: 0.8"></a-entity>
  <a-entity light="type: directional; intensity: 0.6" position="0 1 1"></a-entity>

  <!-- 1) GRASS NFT MARKER -->
  <a-nft
    type="nft"
    url="GRASS"
    id="grassMarker"
    smooth="true"
    smoothCount="10"
    smoothTolerance="0.01"
    smoothThreshold="5">

    <a-plane id="dragplaneGrass" class="raytarget"
             position="0 0 0" rotation="-90 0 0" width="2" height="2"
             material="color: #000; opacity: 0; transparent: true"></a-plane>

    <a-box id="cubeGrass" class="raytarget"
           position="0 0.25 0"
           width="1.5" height="1.5" depth="1.5"
           material="metalness:0.1; roughness:0.6; color:#4CC3D9"
           tap-gestures spin-toggle
           drag-on-plane="plane: #dragplaneGrass; yOffset: 0.25; radius: 1.2"
           pinch-scale twist-rotate>
    </a-box>

  </a-nft>

  <!-- 2) GRASSHOPPER NFT MARKER -->
  <a-nft
    type="nft"
    url="GRASSHOPPER"
    id="grasshopperMarker"
    smooth="true"
    smoothCount="10"
    smoothTolerance="0.01"
    smoothThreshold="5">

    <a-entity id="grasshopperGroup">

      <a-plane id="dragplaneGrasshopper" class="raytarget"
               position="0 0 0" rotation="-90 0 0" width="2" height="2"
               material="color: #000; opacity: 0; transparent: true"></a-plane>

      <a-box id="cubeGrasshopper" class="raytarget"
             position="0 0.25 0"
             width="1.5" height="1.5" depth="1.5"
             material="metalness:0.1; roughness:0.6; color:#7BC8A4"
             tap-gestures spin-toggle
             drag-on-plane="plane: #dragplaneGrasshopper; yOffset: 0.25; radius: 1.2"
             pinch-scale twist-rotate>
      </a-box>

    </a-entity>
  </a-nft>

  <!-- 3) FROG NFT MARKER -->
  <a-nft
    type="nft"
    url="FROG"
    id="frogMarker"
    smooth="true"
    smoothCount="10"
    smoothTolerance="0.01"
    smoothThreshold="5">

    <a-entity id="frogGroup">

      <a-plane id="dragplaneFrog" class="raytarget"
               position="0 0 0" rotation="-90 0 0" width="2" height="2"
               material="color: #000; opacity: 0; transparent: true"></a-plane>

      <a-box id="cubeFrog" class="raytarget"
             position="0 0.25 0"
             width="1.5" height="1.5" depth="1.5"
             material="metalness:0.1; roughness:0.6; color:#FFC65D"
             tap-gestures spin-toggle
             drag-on-plane="plane: #dragplaneFrog; yOffset: 0.25; radius: 1.2"
             pinch-scale twist-rotate>
      </a-box>

    </a-entity>
  </a-nft>

  <a-entity camera></a-entity>
</a-scene>

<script>
  const hud      = document.getElementById('hud');
  const message  = document.getElementById('message');

  const cubeGrass = document.getElementById('cubeGrass');

  const grassMarker       = document.getElementById('grassMarker');
  const grasshopperMarker = document.getElementById('grasshopperMarker');
  const frogMarker        = document.getElementById('frogMarker');

  const grasshopperGroup  = document.getElementById('grasshopperGroup');
  const frogGroup         = document.getElementById('frogGroup');

  // HUD controls Grass cube
  document.getElementById('btn-rot-l').addEventListener('click', () => nudgeRot(-15));
  document.getElementById('btn-rot-r').addEventListener('click', () => nudgeRot( 15));

  function nudgeRot(delta){
    const r = cubeGrass.getAttribute('rotation');
    cubeGrass.setAttribute('rotation', {x:r.x, y:r.y + delta, z:r.z});
  }

  document.getElementById('btn-scale--').addEventListener('click', () => nudgeScale(0.9));
  document.getElementById('btn-scale-+').addEventListener('click', () => nudgeScale(1.1));

  function nudgeScale(mult){
    const s = cubeGrass.getAttribute('scale');
    cubeGrass.setAttribute('scale', {
      x: clamp(s.x * mult, 0.2, 3),
      y: clamp(s.y * mult, 0.2, 3),
      z: clamp(s.z * mult, 0.2, 3)
    });
  }

  document.getElementById('btn-color').addEventListener('click', () =>
    cubeGrass.emit('random-color')
  );

  cubeGrass.addEventListener('tap',       () => cubeGrass.emit('toggle-spin'));
  cubeGrass.addEventListener('doubletap', () => cubeGrass.emit('random-color'));
  cubeGrass.addEventListener('longpress', () => hud.classList.toggle('hidden'));

  // -------- helper to show top banner --------
  function showMessage(text) {
    message.textContent = text;
    message.style.display = 'block';
    setTimeout(() => {
      message.style.display = 'none';
    }, 3000);
  }

  // ----------------- UNLOCK LOGIC -----------------
  let grassSeen        = false;
  let grasshopperSeen  = false;

  grasshopperGroup.setAttribute('visible', false);
  frogGroup.setAttribute('visible', false);

  // GRASS scanned
  grassMarker.addEventListener('markerFound', () => {
    grassSeen = true;
  });

  // GRASSHOPPER scanned
  grasshopperMarker.addEventListener('markerFound', () => {
    if (grassSeen) {
      grasshopperSeen = true;
      grasshopperGroup.setAttribute('visible', true);
      showMessage('ðŸŽ‰ Congratulations! You guessed it right!');
    } else {
      grasshopperGroup.setAttribute('visible', false);
    }
  });

  grasshopperMarker.addEventListener('markerLost', () => {
    grasshopperGroup.setAttribute('visible', false);
  });

  // FROG scanned
  frogMarker.addEventListener('markerFound', () => {
    if (grasshopperSeen) {
      frogGroup.setAttribute('visible', true);
      showMessage('ðŸ¸ The frog eats the grasshopper â€“ next step in the food chain!');
    } else {
      frogGroup.setAttribute('visible', false);
    }
  });

  frogMarker.addEventListener('markerLost', () => {
    frogGroup.setAttribute('visible', false);
  });
</script>

</body>
</html>
