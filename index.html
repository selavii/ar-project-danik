<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Food Chain AR Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

  <!-- AR.js NFT -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin:0; overflow:hidden; }

    .popup {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) scale(0.8);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 14px 22px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      opacity: 0;
      transition: 0.35s ease;
      z-index: 30;
    }
    .popup.show {
      opacity: 1;
      transform: translateX(-50%) scale(1);
    }

    .hud {
      position: fixed; bottom: 14px; left: 50%; transform: translateX(-50%);
      display: grid; grid-template-columns: repeat(5, auto); gap: 8px;
      font: 600 14px/1 system-ui;
      z-index: 10; pointer-events: none;
    }

    .hud.hidden { display:none; }

    .hud button {
      pointer-events: auto;
      padding:10px 12px;
      border:0;
      border-radius:10px;
      background:rgba(255,255,255,.9);
    }
  </style>

  <script>
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

    // ---- POPUP MESSAGE ----
    function showPopup(text, good=true){
      const pop = document.getElementById("popup");
      pop.innerText = text;
      pop.style.background = good ? "rgba(0,160,0,0.85)" : "rgba(180,0,0,0.9)";
      pop.classList.add("show");
      setTimeout(()=> pop.classList.remove("show"), 2000);
    }

    // ---- FOOD CHAIN PROGRESSION ----
    let currentStage = 0;
    const order = ["grass","grasshopper","frog","snake","eagle"];

    function foundMarker(name){
      if(name === order[currentStage]){
        showPopup("Correct! â†’ " + name.toUpperCase(), true);
        currentStage++;
      } else {
        showPopup("Wrong order! Try again!", false);
      }
    }

    // --- GESTURES ---
    AFRAME.registerComponent('tap-gestures', {
      schema: {longMs:{default:500}},
      init () {
        let lastTap = 0, pressTimer = null, down = false;

        this.el.addEventListener('mousedown', () => {
          down = true;
          const now = performance.now();
          if(now - lastTap < 300) this.el.emit('doubletap');
          lastTap = now;

          pressTimer = setTimeout(()=>{ if(down) this.el.emit('longpress'); }, this.data.longMs);
        });

        this.el.addEventListener('mouseup', () => {
          down = false;
          clearTimeout(pressTimer);
          this.el.emit('tap');
        });
      }
    });

    AFRAME.registerComponent('pinch-scale', {
      schema:{min:{default:0.2}, max:{default:3}},
      init(){
        this.active = false; this.startD=0; this.startScale=null;

        const dist = (a,b)=> Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY);
        const onStart = (e)=>{
          if(e.touches?.length===2){
            this.active = true;
            this.startD = dist(e.touches[0], e.touches[1]);
            this.startScale = {...this.el.getAttribute('scale')};
          }
        };
        const onMove = (e)=>{
          if(!this.active || e.touches?.length<2) return;
          const d = dist(e.touches[0], e.touches[1]);
          const mult = d / this.startD;
          const ns = {
            x: clamp(this.startScale.x * mult, this.data.min, this.data.max),
            y: clamp(this.startScale.y * mult, this.data.min, this.data.max),
            z: clamp(this.startScale.z * mult, this.data.min, this.data.max),
          };
          this.el.setAttribute('scale', ns);
        };
        const onEnd = ()=> this.active = false;

        window.addEventListener("touchstart", onStart, {passive:false});
        window.addEventListener("touchmove", onMove, {passive:false});
        window.addEventListener("touchend", onEnd);
      }
    });

    AFRAME.registerComponent('twist-rotate', {
      schema:{degPerRad:{default:57.29}},
      init(){
        this.active=false; this.startA=0; this.startRotY=0;

        const angle=(a,b)=> Math.atan2(b.clientY-a.clientY, b.clientX-a.clientX);
        const onStart=(e)=>{
          if(e.touches?.length===2){
            this.active = true;
            this.startA = angle(e.touches[0],e.touches[1]);
            this.startRotY = this.el.getAttribute("rotation").y;
          }
        };
        const onMove=(e)=>{
          if(!this.active || e.touches?.length<2) return;
          const a = angle(e.touches[0],e.touches[1]);
          const delta = (a - this.startA) * this.data.degPerRad;
          const r = this.el.getAttribute("rotation");
          this.el.setAttribute("rotation",{x:r.x, y:this.startRotY+delta, z:r.z});
        };

        const onEnd=()=> this.active=false;

        window.addEventListener("touchstart",onStart,{passive:false});
        window.addEventListener("touchmove",onMove,{passive:false});
        window.addEventListener("touchend",onEnd);
      }
    });
  </script>
</head>

<body>

<div id="popup" class="popup">Message</div>

<div class="hud" id="hud">
  <button id="btn-rot-l">âŸ²</button>
  <button id="btn-rot-r">âŸ³</button>
  <button id="btn-scale--">âˆ’</button>
  <button id="btn-scale-+">ï¼‹</button>
  <button id="btn-color">ðŸŽ¨</button>
</div>

<a-scene
        embedded
        renderer="colorManagement:true; physicallyCorrectLights:true"
        xr-mode-ui="enabled:false"
        arjs="sourceType:webcam; trackingMethod:best; debugUIEnabled:false;">

  <a-entity id="ray" cursor="rayOrigin:mouse" raycaster="objects:.raytarget"></a-entity>

  <a-entity light="type:ambient; intensity:0.8"></a-entity>
  <a-entity light="type:directional; intensity:0.6" position="0 1 1"></a-entity>

  <!-- =======================
       1) GRASS
  ======================== -->
  <a-nft type="nft" url="grass" id="markerGrass"
         smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
    <a-entity id="grassModel"
              gltf-model="url(models/grass.glb)"
              scale="2 2 2"
              position="0 0 0"
              rotation="0 0 0"
              class="raytarget"
              tap-gestures pinch-scale twist-rotate>
    </a-entity>
  </a-nft>

  <!-- =======================
       2) GRASSHOPPER
  ======================== -->
  <a-nft type="nft" url="grasshopper" id="markerGrasshopper">
    <a-entity gltf-model="url(models/grasshopper.glb)"
              scale="1.6 1.6 1.6"
              position="0 0 0"
              rotation="0 180 0"
              class="raytarget"
              tap-gestures pinch-scale twist-rotate>
    </a-entity>
  </a-nft>

  <!-- =======================
       3) FROG
  ======================== -->
  <a-nft type="nft" url="frog" id="markerFrog">
    <a-entity gltf-model="url(models/frog.glb)"
              scale="2 2 2"
              rotation="0 0 0"
              class="raytarget"
              tap-gestures pinch-scale twist-rotate>
    </a-entity>
  </a-nft>

  <!-- =======================
       4) SNAKE
  ======================== -->
  <a-nft type="nft" url="snake" id="markerSnake">
    <a-entity gltf-model="url(models/snake.glb)"
              scale="1.4 1.4 1.4"
              rotation="0 0 0"
              class="raytarget"
              tap-gestures pinch-scale twist-rotate>
    </a-entity>
  </a-nft>

  <!-- =======================
       5) EAGLE
  ======================== -->
  <a-nft type="nft" url="eagle" id="markerEagle">
    <a-entity gltf-model="url(models/eagle.glb)"
              scale="2.5 2.5 2.5"
              rotation="0 0 0"
              class="raytarget"
              tap-gestures pinch-scale twist-rotate>
    </a-entity>
  </a-nft>

  <a-entity camera></a-entity>
</a-scene>

<script>
  document.querySelectorAll("a-nft").forEach(marker => {
    marker.addEventListener("markerFound", () => {
      const id = marker.getAttribute("url");
      foundMarker(id);
    });
  });
</script>

</body>
</html>
